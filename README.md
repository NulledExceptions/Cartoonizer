# Cartoonizer macOS App - Source

This folder contains all the code used to build and run the Cartoonizer.app bundle.

Files:
- Info.plist               -> macOS app metadata
- cartoonizer_launcher     -> .app executable shell launcher
- cartoonizer.py           -> Stable Diffusion img2img + Gradio GUI + CLI
- requirements.txt         -> Python dependencies
- build_app.sh             -> Helper script to rebuild Cartoonizer.app from these sources

To rebuild the .app from this source folder on macOS:

```bash
mkdir -p Cartoonizer.app/Contents/MacOS
mkdir -p Cartoonizer.app/Contents/Resources

cp Info.plist Cartoonizer.app/Contents/Info.plist
cp cartoonizer_launcher Cartoonizer.app/Contents/MacOS/cartoonizer_launcher
chmod +x Cartoonizer.app/Contents/MacOS/cartoonizer_launcher
cp cartoonizer.py Cartoonizer.app/Contents/Resources/cartoonizer.py
cp requirements.txt Cartoonizer.app/Contents/Resources/requirements.txt
```

Then double-click Cartoonizer.app to run it (right-click → Open the first time).

## Runtime data & troubleshooting

The launcher now stores everything writable in `~/Library/Application Support/Cartoonizer/` so the app can run even when copied to `/Applications` (where the bundle is read-only):

- `venv/` – Python virtual environment
- `hf_cache/` – Hugging Face caches/models
- `launcher.log` – stdout/stderr from the shell launcher, now written to `/Users/markmarnell/Code/Cartoonizer_Full_App_and_Source/log/launcher.log` for easy inspection while developing. The launcher logs each major step (venv creation, dependency install, app start) and exports `PYTHONUNBUFFERED=1` so Python output streams immediately instead of buffering.
- At launch we also export `OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`, `PYTORCH_ENABLE_MPS_FALLBACK=1`, and `PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0` to prevent macOS from killing PyTorch/Gradio worker processes when they spawn background threads on Apple Silicon or hit aggressive MPS memory limits.

You can delete that folder to reset the environment, or inspect `launcher.log` to understand why the app failed to launch.

## Dependency pinning

`requirements.txt` now pins versions that are known to work on macOS + Python 3.9 (e.g. `torch==2.1.2`, `gradio==3.50.2`, etc.). The launcher re-installs packages automatically whenever the hash of `Cartoonizer.app/Contents/Resources/requirements.txt` changes, so updating that file is all you need to ship new dependency versions.

## UI feedback

The Gradio UI shows a dedicated **Status / Progress** panel and leverages `gr.Progress(track_tqdm=True)` (with the queue enabled) so first-run model downloads and later inferences visibly stream updates instead of appearing frozen. Tell users to keep the window open until the status reports “Done!” after the first generation.

The Blocks layout now uses a custom Soft theme, hero section, and additional CSS (see `CUSTOM_CSS` in `cartoonizer.py`) to deliver a modern, dark-glass interface. The default Gradio footer/API buttons are hidden via CSS/`show_api=False`, and the web UI favicon is set to the bundled cartoonizer icon (`cartoonizer_web_icon.png`).

To keep VRAM/RAM usage reasonable on 8–16 GB Macs, the Python code now:
- Loads Stable Diffusion checkpoints with `low_cpu_mem_usage=True` and safetensors, then enables VAE slicing/tiling and attention slicing.
- Resizes uploads to a max side of 768 px by default (override with `CARTOONIZER_MAX_SIDE` if you have the headroom).
- Logs every major step (`[Cartoonizer] ...`) so `launcher.log` always shows what the Python side was doing when something failed.

## Ports

The GUI tries to bind to `127.0.0.1:7860` but now falls back to a random free localhost port when 7860 is taken (the actual port is printed to `launcher.log`). This prevents crashes when another process is already using 7860.

On launch, the script logs the chosen URL and automatically opens the system browser (via `webbrowser.open`) so the UI appears without manual steps. If the auto-open fails (e.g. headless session), users can open the printed URL themselves.

## App icon

- Base artwork: `source/assets/cartoonizer_icon_1024.png` (generated procedurally via `python3 source/scripts/generate_icon.py` to depict a stylized lens + paintbrush inside a rounded gradient badge).
- Web favicon: `source/assets/cartoonizer_web_icon.png` (generated by the same script and copied into `Cartoonizer.app/Contents/Resources/cartoonizer_web_icon.png` for Gradio to reference).
- Icon bundle: `source/assets/Cartoonizer.iconset` → `source/assets/Cartoonizer.icns` (the script builds the down-scaled PNGs and packs them directly into the ICNS container—no external tools needed).
- The `.icns` is copied to `Cartoonizer.app/Contents/Resources/Cartoonizer.icns`, and both `source/Info.plist` + the bundle's Info.plist set `CFBundleIconFile` to `Cartoonizer`, so macOS displays the custom icon in Finder/Dock.
